name: RDP via Cloudflare

on: workflow_dispatch

jobs:
  rdp-tunnel:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: è®¾ç½®RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        $Password = ConvertTo-SecureString -AsPlainText "${{ secrets.RDP_PASSWORD }}" -Force
        New-LocalUser -Name "githubuser" -Password $Password -PasswordNeverExpires
        Add-LocalGroupMember -Group "Administrators" -Member "githubuser"

    - name: ä¸‹è½½Cloudflared
      run: |
        Invoke-WebRequest https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe

    - name: å¯åŠ¨éš§é“ï¼ˆæœ€ç»ˆæ–¹æ¡ˆï¼‰
      run: |
        Stop-Process -Name "cloudflared" -Force -ErrorAction SilentlyContinue
        $env:CLOUDFLARE_TOKEN="${{ secrets.CLOUDFLARE_TOKEN }}"
        Start-Process -NoNewWindow -FilePath ".\cloudflared.exe" `
          -ArgumentList "tunnel", "--loglevel", "debug", "run", "--url", "rdp://localhost:3389", "--token", "$env:CLOUDFLARE_TOKEN" `
          -RedirectStandardOutput "tunnel.log" `
          -RedirectStandardError "tunnel-error.log"
        
        Start-Sleep -Seconds 180
        $logContent = Get-Content "tunnel.log" -Tail 100
        if ($logContent -match "https://(.+\.trycloudflare\.com)") {
            echo "RDP_URL=$($matches[1])" >> $env:GITHUB_ENV
        } else {
            Get-Content "tunnel-error.log"
            exit 1
        }

    - name: æ˜¾ç¤ºè¿æ¥ä¿¡æ¯
      run: |
        Write-Host "========================================"
        Write-Host "ğŸ–¥ï¸ è¿æ¥åœ°å€: $env:RDP_URL"
        Write-Host "ğŸ‘¤ ç”¨æˆ·å: githubuser"
        Write-Host "ğŸ”‘ å¯†ç : ${{ secrets.RDP_PASSWORD }}"
        Write-Host "========================================"
