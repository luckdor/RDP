name: Free RDP via Cloudflare (No Domain)

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

jobs:
  rdp-tunnel:
    runs-on: windows-latest
    timeout-minutes: 360 # æœ€é•¿6å°æ—¶

    steps:
    - name: è®¾ç½®è¿œç¨‹æ¡Œé¢
      run: |
        # å¯ç”¨RDPæœåŠ¡
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        
        # åˆ›å»ºä¸´æ—¶ç”¨æˆ·
        $Password = ConvertTo-SecureString -AsPlainText "${{ secrets.RDP_PASSWORD }}" -Force
        New-LocalUser -Name "githubuser" -Password $Password -PasswordNeverExpires
        Add-LocalGroupMember -Group "Administrators" -Member "githubuser"

    - name: ä¸‹è½½Cloudflared
      run: |
        Invoke-WebRequest https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe

    - name: å¯åŠ¨éš§é“
      run: |
        # ç»ˆæ­¢æ—§è¿›ç¨‹
        Stop-Process -Name "cloudflared" -Force -ErrorAction SilentlyContinue
    
        # å¯åŠ¨éš§é“ï¼ˆæŒ‡å®šé¦™æ¸¯åŒºåŸŸï¼‰
        $tunnelArgs = "tunnel --region hk --loglevel debug --no-autoupdate run --url rdp://localhost:3389 --token ${{ secrets.CLOUDFLARE_TOKEN }}"
        Start-Process -NoNewWindow -FilePath ".\cloudflared.exe" -ArgumentList $tunnelArgs -RedirectStandardOutput tunnel.log -RedirectStandardError tunnel-error.log
    
        # ç­‰å¾… 2 åˆ†é’Ÿ
        Start-Sleep -Seconds 120
    
        # åˆ†ææ—¥å¿—
        $logContent = Get-Content tunnel.log -Tail 100
        if ($logContent -match "https://(.+\.trycloudflare\.com)") {
            Write-Host "âœ… RDPåœ°å€: $matches[1]"
            echo "RDP_URL=$matches[1]" >> $env:GITHUB_ENV
        } else {
            Write-Host "::error::éš§é“å¯åŠ¨å¤±è´¥ï¼Œå®Œæ•´æ—¥å¿—ï¼š"
            Get-Content tunnel.log
            Get-Content tunnel-error.log
            exit 1
        }
    - name: æ˜¾ç¤ºè¿æ¥ä¿¡æ¯
      run: |
        Write-Host "========================================"
        Write-Host "ğŸ–¥ï¸ ä½¿ç”¨ä»¥ä¸‹ä¿¡æ¯è¿æ¥è¿œç¨‹æ¡Œé¢:"
        Write-Host "åœ°å€: $env:RDP_URL"
        Write-Host "ç”¨æˆ·å: githubuser"
        Write-Host "å¯†ç : ${{ secrets.RDP_PASSWORD }}"
        Write-Host "========================================"
        Write-Host "æ³¨æ„ï¼šæ­¤åœ°å€ä¼šåœ¨å·¥ä½œæµç»“æŸåå¤±æ•ˆ"
        
    - name: ä¿æŒè¿æ¥
      run: while ($true) { Start-Sleep -Seconds 300 }
