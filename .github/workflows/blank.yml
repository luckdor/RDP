name: Free RDP via Cloudflare (No Domain)

on:
  workflow_dispatch: # 手动触发

jobs:
  rdp-tunnel:
    runs-on: windows-latest
    timeout-minutes: 360 # 最长6小时

    steps:
    - name: 设置远程桌面
      run: |
        # 启用RDP服务
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        
        # 创建临时用户
        $Password = ConvertTo-SecureString -AsPlainText "${{ secrets.RDP_PASSWORD }}" -Force
        New-LocalUser -Name "githubuser" -Password $Password -PasswordNeverExpires
        Add-LocalGroupMember -Group "Administrators" -Member "githubuser"

    - name: 下载Cloudflared
      run: |
        Invoke-WebRequest https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe

    - name: 启动隧道
      run: |
        # 启动隧道（明确指定 RDP 端口和 Token）
        Start-Process -NoNewWindow -FilePath ".\cloudflared.exe" -ArgumentList "tunnel --no-autoupdate run --url rdp://localhost:3389 --token ${{ secrets.CLOUDFLARE_TOKEN }}" -RedirectStandardOutput tunnel.log
    
        # 等待隧道初始化
        Start-Sleep -Seconds 30  # 延长等待时间
    
        # 从日志提取地址（检查最后 20 行）
        $logContent = Get-Content tunnel.log -Tail 20
         if ($logContent -match "https://(.+\.trycloudflare\.com)") {
        $rdpUrl = $matches[1]
        Write-Host "✅ RDP地址: $rdpUrl"
        echo "RDP_URL=$rdpUrl" >> $env:GITHUB_ENV
        } else {
        Write-Host "::error::隧道启动失败，完整日志："
        Get-Content tunnel.log
        exit 1
        }
    - name: 显示连接信息
      run: |
        Write-Host "========================================"
        Write-Host "🖥️ 使用以下信息连接远程桌面:"
        Write-Host "地址: $env:RDP_URL"
        Write-Host "用户名: githubuser"
        Write-Host "密码: ${{ secrets.RDP_PASSWORD }}"
        Write-Host "========================================"
        Write-Host "注意：此地址会在工作流结束后失效"
        
    - name: 保持连接
      run: while ($true) { Start-Sleep -Seconds 300 }
